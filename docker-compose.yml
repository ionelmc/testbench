services:
  requirements:
    build:
      context: docker/requirements
    volumes:
      - ./requirements:/requirements
      - ./.home/requirements:/home/app
    env_file:
      - .env

  test:
    extends:
      service: python
      file: docker-compose.common.yml
    build:
      args:
        REQUIREMENTS: test
        DJANGO_SETTINGS_MODULE: 'testbench_project.settings_test'
    entrypoint: /app/tests/entrypoint.sh
    environment:
      PYTHONPATH: /app/src:/app/tests
      DJANGO_DEBUG:
      DJANGO_DEBUG_SQL:
      DJANGO_DEBUG_SQL_LIMIT:
      PYTHONHUNTER:
      PYTHONHUNTERCONFIG:
      SERVER_NAME: localhost
      DJANGO_SECRET_KEY: test123
      SENTRY_DSN: ''
    stop_signal: SIGINT
    depends_on:
      - nginx
      - granian
    volumes:
      - ./:/app
      - ./.home:/var/app

  uwsgi:
    extends:
      service: python
      file: docker-compose.common.yml
    env_file:
      - .env
    volumes:
      - ./.home/run:/var/app/run
    command: [
      uwsgi,
      --disable-logging,
      --ini=/etc/app/uwsgi.ini,
      --processes=10,
    ]

  uvicorn:
    extends:
      service: python
      file: docker-compose.common.yml
    entrypoint: []
    command: [
      pysu, app, --,
      uvicorn,
      --http=httptools,
      --loop=uvloop,
      --uds=/var/app/run/uvicorn.sock,
      --workers=10,
      --ws=none,
      testbench_project.asgi:application,
    ]

  granian-asgi:
    extends:
      service: python
      file: docker-compose.common.yml
    entrypoint: []
    command: [
      granian,
      --backlog=2048,
      --backpressure=1024,
      --http=1,
      --interface=asgi,
      --log-level=info,
      --loop=uvloop,
      --no-ws,
      --uds=/var/app/run/granian-asgi.sock,
      --workers=1,
      --runtime-mode=mt,
      --runtime-threads=10,
      testbench_project.asgi:application,
    ]

  granian-wsgi:
    extends:
      service: python
      file: docker-compose.common.yml
    entrypoint: []
    command: [
      granian,
      --backlog=2048,
      --backpressure=1024,
      --http=1,
      --interface=wsgi,
      --log-level=info,
      --no-ws,
      --uds=/var/app/run/granian-wsgi.sock,
      --workers=1,
      --runtime-mode=mt,
      --runtime-threads=10,
      --blocking-threads=10,
      testbench_project.wsgi:application,
    ]

  granian:
    extends:
      service: python
      file: docker-compose.common.yml
    command: [
      granian,
      --backlog=2048,
      --backpressure=1024,
      --http=2,
      --ssl-certificate=/etc/app/fullchain.pem,
      --ssl-keyfile=/etc/app/privkey.pem,
      --interface=wsgi,
      --log-level=info,
      --no-ws,
      --host=0.0.0.0,
      --port=443,
      --workers=10,
      --runtime-mode=st,
      --runtime-threads=10,
      --blocking-threads=1,
      testbench_project.wsgi:application,
    ]
#    ports:
#      - '443:443'

  nginx:
    extends:
      service: python
      file: docker-compose.common.yml
    build:
      args:
        REQUIREMENTS: nginx
    volumes:
      - ./.home/etc:/shared/${SERVER_NAME}/etc
      - ./.home/run:/shared/${SERVER_NAME}/run
      - ./.home/etc:/etc/app
    depends_on:
      - uwsgi
      - granian-asgi
      - granian-wsgi
      - uvicorn
#    ports:
#      - '80:80'
#      - '443:443'
    command: [
      holdup,
      -vt5,
      'unix:///var/app/run/uwsgi.sock',
      'unix:///var/app/run/granian-asgi.sock',
      'unix:///var/app/run/granian-wsgi.sock',
      'unix:///var/app/run/uvicorn.sock',
      --,
      nginx,
    ]
